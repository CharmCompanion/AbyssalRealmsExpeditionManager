@tool
extends EditorScript

func _run() -> void:
	var ts_path := "res://assets/tilesets/fantasy_iso/Fantasy_Ground.tres"
	var ts := TileSet.new()
	
	# Apply isometric settings
	ts.tile_shape = TileSet.TILE_SHAPE_ISOMETRIC
	ts.tile_layout = TileSet.TILE_LAYOUT_STACKED
	ts.tile_offset_axis = TileSet.TILE_OFFSET_AXIS_VERTICAL
	# 2:1 footprint for the pack's 128x256 tiles.
	ts.tile_size = Vector2i(128, 64)
	
	# Get all ground textures
	var ground_dir := "res://imported/Map and Character/Fantasy tileset - 2D Isometric/Environment/Ground"
	var dir := DirAccess.open(ground_dir)
	if dir == null:
		push_error("[RebuildGround] Cannot open: %s" % ground_dir)
		return
	
	var textures: Array[Texture2D] = []
	var tex_names: Array[String] = []
	
	dir.list_dir_begin()
	while true:
		var file := dir.get_next()
		if file == "":
			break
		if file.ends_with(".png"):
			var tex_path := ground_dir.path_join(file)
			var tex := load(tex_path) as Texture2D
			if tex:
				textures.append(tex)
				tex_names.append(file)
	dir.list_dir_end()
	
	print("[RebuildGround] Found %d textures" % textures.size())
	
	# Create atlas sources
	for i in range(textures.size()):
		var atlas := TileSetAtlasSource.new()
		atlas.texture = textures[i]
		atlas.texture_region_size = Vector2i(128, 256)
		atlas.separation = Vector2i(0, 0)
		atlas.margins = Vector2i(0, 0)
		
		# Each PNG is a single 128x256 tile.
		var coords := Vector2i(0, 0)
		atlas.create_tile(coords)
		var data := atlas.get_tile_data(coords, 0)
		if data:
			# Pivot at (64,46) -> align to diamond center (64,32).
			data.texture_origin = Vector2i(0, -14)

		print("[RebuildGround] Added source %d: %s (1 tile)" % [i + 1, tex_names[i]])
	
	# Save
	if ResourceSaver.save(ts, ts_path) == OK:
		print("[RebuildGround] Saved to: %s" % ts_path)
	else:
		push_error("[RebuildGround] Failed to save!")
