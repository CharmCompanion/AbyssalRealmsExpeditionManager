<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Abyssal Realms</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<div class="resource-bar" id="resource-bar" style="display:none;">
    <div class="resource-item"><span class="resource-icon">üí∞</span><span class="resource-value" id="res-gold">0</span></div>
    <div class="resource-item"><span class="resource-icon">üçñ</span><span class="resource-value" id="res-food">0</span></div>
    <div class="resource-item"><span class="resource-icon">ü™µ</span><span class="resource-value" id="res-wood">0</span></div>
    <div class="resource-item"><span class="resource-icon">ü™®</span><span class="resource-value" id="res-stone">0</span></div>
    <div class="resource-item"><span class="resource-icon">‚õèÔ∏è</span><span class="resource-value" id="res-ore">0</span></div>
    <div class="resource-item"><span class="resource-icon">üíé</span><span class="resource-value" id="res-gems">0</span></div>
    <div class="resource-item"><span class="resource-icon">üè∫</span><span class="resource-value" id="res-relics">0</span></div>
    <div class="resource-item"><span class="resource-icon">üìö</span><span class="resource-value" id="res-knowledge">0</span></div>
    <div class="resource-item"><span class="resource-icon">‚ú®</span><span class="resource-value" id="res-mana">0</span></div>
    <div class="resource-item"><span class="resource-icon">üë•</span><span class="resource-value" id="res-population">0</span></div>
    <div class="day-counter" id="day-counter">Day 1</div>
</div>

<div class="main-content" id="main-content">

    <div class="screen active" id="title-screen">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center;padding:20px;">
            <h1 style="font-size:42px;font-weight:700;color:var(--accent);margin-bottom:8px;letter-spacing:2px;">Abyssal Realms</h1>
            <p style="font-size:16px;color:var(--text-secondary);margin-bottom:48px;font-style:italic;">Expedition Manager</p>
            <div style="display:flex;flex-direction:column;gap:12px;width:100%;max-width:280px;">
                <button class="btn btn-primary btn-lg btn-block" onclick="continueGame()">Continue</button>
                <button class="btn btn-secondary btn-lg btn-block" onclick="showScreen('save-select-screen');loadSaves();selectedSlot=-1;">New Game</button>
                <button class="btn btn-secondary btn-lg btn-block" onclick="showScreen('save-select-screen');loadSaves();selectedSlot=-1;">Load Game</button>
            </div>
        </div>
    </div>

    <div class="screen" id="save-select-screen">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="showScreen('title-screen')">‚Üê Back</button>
            <h2 class="section-title" style="margin-bottom:0;">Select Save Slot</h2>
        </div>
        <div id="save-slots-grid"></div>
    </div>

    <div class="screen create-screen" id="create-screen">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="showScreen('save-select-screen');loadSaves();">‚Üê Back</button>
            <h2 class="section-title" style="margin-bottom:0;">Create New Game</h2>
        </div>

        <div class="creation-tabs">
            <button class="creation-tab active" id="tab-town" onclick="switchCreationTab('town')">Town</button>
            <button class="creation-tab" id="tab-kingdom" onclick="switchCreationTab('kingdom')">Kingdom</button>
            <button class="creation-tab" id="tab-lord" onclick="switchCreationTab('lord')">Lord</button>
        </div>

        <div id="creation-town" class="creation-content">
            <div class="card">
                <div class="form-group">
                    <label>Town Name</label>
                    <input type="text" id="town-name-input" placeholder="Enter town name" oninput="updateSeed(); updateCreateButton();">
                </div>
                <div class="form-group">
                    <label>Seed <span style="font-size:11px;color:var(--text-secondary);">(auto-generated from your settings)</span></label>
                    <input type="text" id="seed-input" readonly style="opacity:0.7;cursor:default;">
                </div>
            </div>
            <div class="card">
                <h3 class="card-title mb-12">Starting Resources</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;">
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">üí∞ Gold</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('gold',-10)">‚àí</button>
                            <span class="resource-val" id="create-gold">200</span>
                            <button onclick="adjustResource('gold',10)">+</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">üë• Population</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('population',-1)">‚àí</button>
                            <span class="resource-val" id="create-population">10</span>
                            <button onclick="adjustResource('population',1)">+</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">üçñ Food</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('food',-10)">‚àí</button>
                            <span class="resource-val" id="create-food">100</span>
                            <button onclick="adjustResource('food',10)">+</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">ü™µ Wood</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('wood',-10)">‚àí</button>
                            <span class="resource-val" id="create-wood">100</span>
                            <button onclick="adjustResource('wood',10)">+</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">ü™® Stone</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('stone',-10)">‚àí</button>
                            <span class="resource-val" id="create-stone">50</span>
                            <button onclick="adjustResource('stone',10)">+</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‚õèÔ∏è Ore</label>
                        <div class="resource-control">
                            <button onclick="adjustResource('ore',-10)">‚àí</button>
                            <span class="resource-val" id="create-ore">0</span>
                            <button onclick="adjustResource('ore',10)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="creation-kingdom" class="creation-content" style="display:none;">
            <div class="creation-layout">
                <div class="creation-form">
                    <div class="kingdom-grid">
                        <button class="kingdom-btn" data-kingdom="vylfod" onclick="selectKingdom(1)">
                            <div class="kingdom-name">Vylfod Dominion</div>
                        </button>
                        <button class="kingdom-btn" data-kingdom="rabaric" onclick="selectKingdom(2)">
                            <div class="kingdom-name">Rabaric Republic</div>
                        </button>
                        <button class="kingdom-btn" data-kingdom="elruhn" onclick="selectKingdom(3)">
                            <div class="kingdom-name">Kingdom of El'Ruhn</div>
                        </button>
                        <button class="kingdom-btn" data-kingdom="kelsin" onclick="selectKingdom(4)">
                            <div class="kingdom-name">Kelsin Federation</div>
                        </button>
                        <button class="kingdom-btn" data-kingdom="gosain" onclick="selectKingdom(5)">
                            <div class="kingdom-name">Divine Empire of Gosain</div>
                        </button>
                        <button class="kingdom-btn" data-kingdom="yozuan" onclick="selectKingdom(6)">
                            <div class="kingdom-name">Yozuan Desert</div>
                        </button>
                    </div>

                    <div id="kingdom-details" class="card" style="display:none;">
                        <h3 id="kingdom-detail-name" class="text-gold mb-8"></h3>
                        <div class="card-body">
                            <p><strong>Biomes:</strong> <span id="kingdom-detail-biomes"></span></p>
                            <p><strong>Climate:</strong> <span id="kingdom-detail-climate"></span></p>
                            <p><strong>Favored Resources:</strong> <span id="kingdom-detail-favored"></span></p>
                            <p><strong>Favored Building:</strong> <span id="kingdom-detail-building"></span></p>
                        </div>
                    </div>

                    <div id="deity-info" class="deity-card" style="display:none;">
                        <div class="deity-name" id="deity-name"></div>
                        <div class="deity-desc" id="deity-domain"></div>
                        <div class="deity-bonus"><strong>Passive:</strong> <span id="deity-passive"></span></div>
                        <div class="deity-bonus" style="color:var(--mana);"><strong>Active:</strong> <span id="deity-active"></span></div>
                        <div class="deity-bonus" style="color:var(--danger);"><strong>Bane:</strong> <span id="deity-bane"></span></div>
                    </div>
                </div>

                <div class="map-panel">
                    <div class="map-container" id="kingdom-map">
                        <img class="map-layer" src="/static/images/map/map.png" alt="" draggable="false">
                        <img class="map-layer" src="/static/images/map/Water.png" alt="" draggable="false">
                        <img class="map-layer" src="/static/images/map/BorderLines.png" alt="" draggable="false">
                        <img class="map-layer" src="/static/images/map/Names.png" alt="" draggable="false">
                        <img class="map-layer" id="highlight-1" src="/static/images/map/VylfodDominionHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="highlight-2" src="/static/images/map/RabaricRepublicHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="highlight-3" src="/static/images/map/KingdomofElRuhnHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="highlight-4" src="/static/images/map/KelsinFederationHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="highlight-5" src="/static/images/map/DivineEmpireofGosainHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="highlight-6" src="/static/images/map/YozuanDesertHighlight.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-1" src="/static/images/map/VylfodDominionShadow.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-2" src="/static/images/map/RabaricRepublicShadow.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-3" src="/static/images/map/KingdomofElRuhnShadow.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-4" src="/static/images/map/KelsinFederationShadow.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-5" src="/static/images/map/DivineEmpireofGosainShadow.png" alt="" draggable="false" style="display:none;">
                        <img class="map-layer" id="shadow-6" src="/static/images/map/YozuanDesertShadow.png" alt="" draggable="false" style="display:none;">
                        <div class="city-dot" id="city-dot" style="display:none;"></div>
                    </div>
                    <div class="map-controls">
                        <span class="kingdom-display" id="map-kingdom-label"></span>
                        <button class="btn btn-secondary btn-sm" onclick="randomizeDot()">Randomize Position</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="creation-lord" class="creation-content" style="display:none;">
            <div class="card">
                <div class="form-group">
                    <label>Lord Name</label>
                    <input type="text" id="lord-name-input" placeholder="Enter lord name" oninput="updateSeed(); updateCreateButton();">
                </div>
                <div class="form-group" style="margin-top:8px;">
                    <label>Title</label>
                    <div class="lord-option-row">
                        <button class="lord-cycle-btn" onclick="cycleLordOption('title',-1)">‚Äπ</button>
                        <span class="lord-option-val" id="lord-title-val">Lord</span>
                        <button class="lord-cycle-btn" onclick="cycleLordOption('title',1)">‚Ä∫</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title mb-12">Appearance</h3>
                <div class="lord-preview-wrap">
                    <div class="lord-preview" id="lord-preview">
                        <div class="lord-preview-body" id="lp-body"></div>
                        <div class="lord-preview-head" id="lp-head"></div>
                        <div class="lord-preview-hair" id="lp-hair"></div>
                        <div class="lord-preview-outfit" id="lp-outfit"></div>
                        <div class="lord-preview-accessory" id="lp-acc"></div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="randomizeLordAppearance()" style="margin-top:8px;">Randomize All</button>
                </div>
                <div class="lord-options-grid">
                    <div class="lord-opt-group">
                        <label>Skin Tone</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('skin',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-skin-val">Fair</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('skin',1)">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="lord-opt-group">
                        <label>Hair Style</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('hair',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-hair-val">Short</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('hair',1)">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="lord-opt-group">
                        <label>Hair Color</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('haircolor',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-haircolor-val">Brown</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('haircolor',1)">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="lord-opt-group">
                        <label>Eyes</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('eyes',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-eyes-val">Blue</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('eyes',1)">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="lord-opt-group">
                        <label>Outfit</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('outfit',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-outfit-val">Noble Robes</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('outfit',1)">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="lord-opt-group">
                        <label>Accessory</label>
                        <div class="lord-option-row">
                            <button class="lord-cycle-btn" onclick="cycleLordOption('accessory',-1)">‚Äπ</button>
                            <span class="lord-option-val" id="lord-accessory-val">None</span>
                            <button class="lord-cycle-btn" onclick="cycleLordOption('accessory',1)">‚Ä∫</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end;">
            <button class="btn btn-primary btn-lg" id="create-btn" onclick="submitCreate()" disabled>Create</button>
        </div>
    </div>

    <div class="screen" id="town-screen">
        <div id="town-content" class="tab-content">
            <div class="lord-banner" style="margin-bottom:16px;display:flex;align-items:center;gap:12px;">
                <div id="lord-sprite-container" class="lord-sprite-wrap"></div>
                <div>
                    <h2 class="section-title mb-0" id="town-header-name"></h2>
                    <p class="text-secondary mb-0" id="town-header-lord"></p>
                    <p class="text-secondary" id="town-header-kingdom" style="font-size:11px;"></p>
                </div>
            </div>
            <div class="card-grid" id="buildings-grid"></div>
        </div>

        <div id="map-content" class="tab-content" style="display:none;">
            <h2 class="section-title mb-12">World Map</h2>
            <div class="map-panel">
                <div class="map-container" id="game-map">
                    <img class="map-layer" src="/static/images/map/map.png" alt="" draggable="false">
                    <img class="map-layer" src="/static/images/map/Water.png" alt="" draggable="false">
                    <img class="map-layer" src="/static/images/map/BorderLines.png" alt="" draggable="false">
                    <img class="map-layer" src="/static/images/map/Names.png" alt="" draggable="false">
                    <img class="map-layer" id="game-highlight-1" src="/static/images/map/VylfodDominionHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-highlight-2" src="/static/images/map/RabaricRepublicHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-highlight-3" src="/static/images/map/KingdomofElRuhnHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-highlight-4" src="/static/images/map/KelsinFederationHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-highlight-5" src="/static/images/map/DivineEmpireofGosainHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-highlight-6" src="/static/images/map/YozuanDesertHighlight.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-1" src="/static/images/map/VylfodDominionShadow.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-2" src="/static/images/map/RabaricRepublicShadow.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-3" src="/static/images/map/KingdomofElRuhnShadow.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-4" src="/static/images/map/KelsinFederationShadow.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-5" src="/static/images/map/DivineEmpireofGosainShadow.png" alt="" draggable="false" style="display:none;">
                    <img class="map-layer" id="game-shadow-6" src="/static/images/map/YozuanDesertShadow.png" alt="" draggable="false" style="display:none;">
                    <div class="city-dot" id="game-city-dot" style="display:none;"></div>
                </div>
            </div>
            <div class="card mt-12" id="game-kingdom-info"></div>
        </div>

        <div id="expeditions-content" class="tab-content" style="display:none;">
            <div id="active-expedition"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h2 class="section-title" style="margin-bottom:0;">Expedition Board</h2>
                <span class="text-secondary" id="board-refresh"></span>
            </div>
            <div id="job-board"></div>
        </div>

        <div id="adventurers-content" class="tab-content" style="display:none;">
            <div class="roster-header">
                <h2 class="section-title mb-0">Adventurer Roster</h2>
                <div class="roster-summary" id="roster-summary"></div>
            </div>
            <div id="adventurer-roster">
                <div class="empty-state">
                    <div class="empty-icon">üë•</div>
                    <div class="empty-text">No adventurers recruited yet</div>
                </div>
            </div>
        </div>

        <div id="city-content" class="tab-content" style="display:none;">
            <div class="city-builder-container">
                <canvas id="city-canvas"></canvas>
                <div class="city-sidebar" id="city-sidebar"></div>
            </div>
            <div class="city-controls">
                <button class="btn btn-secondary btn-sm" id="city-rotate-btn" onclick="rotatePlacement()">‚ü≥ Rotate</button>
                <button class="btn btn-danger btn-sm" id="city-demolish-btn" onclick="toggleDemolish()">üî® Demolish</button>
                <span class="text-secondary" id="city-status">Select a building to place</span>
            </div>
        </div>

        <div id="threats-content" class="tab-content" style="display:none;">
            <h2 class="section-title mb-12">Dungeon Threats</h2>
            <div id="threats-list"></div>
            <div id="raid-warnings" class="mt-16"></div>
        </div>

        <div id="population-content" class="tab-content" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h2 class="section-title mb-0">Population</h2>
            </div>
            <div class="pop-stats-bar" id="pop-stats-bar"></div>
            <div class="pop-tabs" id="pop-tabs">
                <button class="pop-tab-btn active" onclick="showPopSubTab('families')">Families</button>
                <button class="pop-tab-btn" onclick="showPopSubTab('singles')">Singles</button>
                <button class="pop-tab-btn" onclick="showPopSubTab('all')">All</button>
            </div>
            <div id="pop-families" class="pop-tab-content active"></div>
            <div id="pop-singles" class="pop-tab-content"></div>
            <div id="pop-all" class="pop-tab-content"></div>
        </div>
    </div>

</div>

<div class="bottom-nav" id="bottom-nav" style="display:none;">
    <button class="nav-tab active" id="nav-town" onclick="showTab('town')">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Town</span>
    </button>
    <button class="nav-tab" id="nav-city" onclick="showTab('city')">
        <span class="nav-icon">üèóÔ∏è</span>
        <span class="nav-label">City</span>
    </button>
    <button class="nav-tab" id="nav-map" onclick="showTab('map')">
        <span class="nav-icon">üó∫Ô∏è</span>
        <span class="nav-label">Map</span>
    </button>
    <button class="nav-tab" id="nav-expeditions" onclick="showTab('expeditions')">
        <span class="nav-icon">‚öîÔ∏è</span>
        <span class="nav-label">Expeditions</span>
    </button>
    <button class="nav-tab" id="nav-adventurers" onclick="showTab('adventurers')">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">Adventurers</span>
    </button>
    <button class="nav-tab" id="nav-threats" onclick="showTab('threats')">
        <span class="nav-icon">üíÄ</span>
        <span class="nav-label">Threats</span>
    </button>
    <button class="nav-tab" id="nav-population" onclick="showTab('population')">
        <span class="nav-icon">üèòÔ∏è</span>
        <span class="nav-label">People</span>
    </button>
</div>

<div class="modal-overlay hidden" id="modal-overlay">
    <div class="modal-content">
        <h3 id="modal-title"></h3>
        <p id="modal-message"></p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
            <button class="btn btn-danger" id="modal-confirm">Confirm</button>
        </div>
    </div>
</div>

<script>
const KINGDOM_DATA = {
    1: {name: "Vylfod Dominion", biomes: ["coastal", "wetlands"], climate: "humid", favored: ["fish", "salt", "herbs"], building: "Harbor"},
    2: {name: "Rabaric Republic", biomes: ["plains", "hills"], climate: "temperate", favored: ["food", "wood", "stone"], building: "Market"},
    3: {name: "Kingdom of El'Ruhn", biomes: ["forest", "mountains"], climate: "temperate", favored: ["wood", "ore", "gems"], building: "Lumberyard"},
    4: {name: "Kelsin Federation", biomes: ["forest", "oasis"], climate: "lush", favored: ["wood", "food", "mana"], building: "Sanctum"},
    5: {name: "Divine Empire of Gosain", biomes: ["tundra", "mountains"], climate: "cold", favored: ["stone", "ore", "relics"], building: "Cathedral"},
    6: {name: "Yozuan Desert", biomes: ["desert", "canyons", "oasis"], climate: "arid", favored: ["stone", "gems", "mana"], building: "Caravanserai"}
};
const KINGDOM_TO_DEITY = {1:0, 5:1, 6:2, 3:3, 4:4, 2:5};
const DEITY_DATA = {
    0: {name: "Nivarius", desc: "Wisdom / Knowledge", passive: "Expedition outcomes are more consistent.", active: "Academy: Reduce casualty chance.", bane: "Building construction takes longer."},
    1: {name: "Seraphina", desc: "Faith", passive: "Less morale loss from deaths.", active: "Temple: Faster wound recovery.", bane: "Loot sells for less Gold."},
    2: {name: "Fortane", desc: "Darkness / Luck", passive: "Higher loot variance.", active: "Bank: Pay gold for better loot.", bane: "Recruitment costs vary."},
    3: {name: "Thorn", desc: "Nature / Food", passive: "Fewer attrition deaths.", active: "Cottages: Spend food to reduce deaths.", bane: "Worse trade income."},
    4: {name: "Aurelia", desc: "Strength", passive: "More survivable combat.", active: "Estates: Train party for next expedition.", bane: "Expeditions use more supplies."},
    5: {name: "Zephra", desc: "Speed", passive: "Expeditions complete faster.", active: "Guild: Shorter prep and cooldown.", bane: "Slower injury recovery."}
};
const KINGDOM_CENTERS = {
    1: {x: 0.6691, y: 0.6751},
    2: {x: 0.3383, y: 0.6837},
    3: {x: 0.4634, y: 0.5389},
    4: {x: 0.6549, y: 0.3997},
    5: {x: 0.4555, y: 0.2821},
    6: {x: 0.2391, y: 0.4314}
};
const KINGDOM_MAP_FILES = {
    1: {highlight: "VylfodDominionHighlight.png", shadow: "VylfodDominionShadow.png"},
    2: {highlight: "RabaricRepublicHighlight.png", shadow: "RabaricRepublicShadow.png"},
    3: {highlight: "KingdomofElRuhnHighlight.png", shadow: "KingdomofElRuhnShadow.png"},
    4: {highlight: "KelsinFederationHighlight.png", shadow: "KelsinFederationShadow.png"},
    5: {highlight: "DivineEmpireofGosainHighlight.png", shadow: "DivineEmpireofGosainShadow.png"},
    6: {highlight: "YozuanDesertHighlight.png", shadow: "YozuanDesertShadow.png"}
};
const BUILDING_TYPES = {
    town_hall: {name: "Town Hall", cost: {gold: 100, wood: 50, stone: 50}, production: {gold: 5}, max_level: 5},
    tavern: {name: "Tavern", cost: {gold: 80, wood: 40}, production: {gold: 3, population: 1}, max_level: 5},
    barracks: {name: "Barracks", cost: {gold: 120, wood: 30, stone: 60}, production: {}, max_level: 5},
    market: {name: "Market", cost: {gold: 150, wood: 40, stone: 30}, production: {gold: 8}, max_level: 5},
    farm: {name: "Farm", cost: {gold: 60, wood: 30}, production: {food: 10}, max_level: 5},
    mine: {name: "Mine", cost: {gold: 100, wood: 20, stone: 40}, production: {ore: 5, stone: 3}, max_level: 5},
    lumber_mill: {name: "Lumber Mill", cost: {gold: 80, wood: 20}, production: {wood: 8}, max_level: 5},
    temple: {name: "Temple", cost: {gold: 200, stone: 80}, production: {mana: 3, knowledge: 2}, max_level: 5},
    library: {name: "Library", cost: {gold: 150, wood: 50, stone: 30}, production: {knowledge: 5}, max_level: 5},
    smithy: {name: "Smithy", cost: {gold: 120, ore: 30, stone: 20}, production: {}, max_level: 5}
};

const BUILDING_ICONS = {
    town_hall: "üèõÔ∏è", tavern: "üç∫", barracks: "‚öîÔ∏è", market: "üè™",
    farm: "üåæ", mine: "‚õèÔ∏è", lumber_mill: "ü™µ", temple: "‚õ™",
    library: "üìö", smithy: "üî®"
};

const RESOURCE_ICONS = {
    gold: "üí∞", food: "üçñ", wood: "ü™µ", stone: "ü™®", ore: "‚õèÔ∏è",
    gems: "üíé", relics: "üè∫", knowledge: "üìö", mana: "‚ú®", population: "üë•"
};

let currentScreen = 'title-screen';
let activeSave = null;
let selectedKingdom = -1;
let selectedSlot = -1;
let gameTickInterval = null;
let boundaryCache = {};
let isDraggingDot = false;

let createResources = {gold: 200, population: 10, food: 100, wood: 100, stone: 50, ore: 0};

async function api(url, method, body) {
    const opts = {method: method || 'GET', headers: {'Content-Type': 'application/json'}};
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    if (!res.ok) {
        const err = await res.text();
        throw new Error(err);
    }
    return res.json();
}

function formatNumber(n) {
    if (n === undefined || n === null) return '0';
    n = Number(n);
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return String(n);
}

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    currentScreen = screenId;

    const inGame = screenId === 'town-screen';
    document.getElementById('resource-bar').style.display = inGame ? 'flex' : 'none';
    document.getElementById('bottom-nav').style.display = inGame ? 'flex' : 'none';

    const mc = document.getElementById('main-content');
    if (inGame) {
        mc.style.top = 'var(--resource-bar-height)';
        mc.style.bottom = 'var(--nav-height)';
    } else {
        mc.style.top = '0';
        mc.style.bottom = '0';
    }
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    const el = document.getElementById(tabName + '-content');
    if (el) el.style.display = 'block';
    setActiveNav(tabName);

    if (tabName === 'map' && activeSave) {
        updateGameMap();
    }
    if (tabName === 'city' && activeSave) {
        initCityBuilder();
    }
    if (tabName === 'population' && activeSave) {
        renderPopulation(activeSave);
    }
}

function setActiveNav(tabName) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    const navEl = document.getElementById('nav-' + tabName);
    if (navEl) navEl.classList.add('active');
}

async function loadSaves() {
    try {
        const data = await api('/api/saves');
        renderSaveSlots(data.saves || data);
    } catch(e) {
        renderSaveSlots([]);
    }
}

function renderSaveSlots(saves) {
    const grid = document.getElementById('save-slots-grid');
    let html = '';
    const saveMap = {};
    if (Array.isArray(saves)) {
        saves.forEach(s => { saveMap[s.slot] = s; });
    }
    for (let i = 1; i <= 20; i++) {
        const save = saveMap[i];
        if (save) {
            const kName = KINGDOM_DATA[save.kingdom_id] ? KINGDOM_DATA[save.kingdom_id].name : 'Unknown';
            html += '<div class="save-slot occupied">' +
                '<div style="flex:1;min-width:0;">' +
                '<div class="slot-header"><span class="slot-number">Slot ' + i + '</span><span class="day-display">Day ' + (save.day || 1) + '</span></div>' +
                '<div class="lord-name">' + (save.lord_name || 'Unknown Lord') + '</div>' +
                '<div class="town-name">' + (save.town_name || 'Unknown Town') + '</div>' +
                '<div class="kingdom-name">' + kName + '</div>' +
                '<div class="resource-preview">' +
                '<div class="resource-item"><span class="resource-icon">üí∞</span><span class="resource-value">' + formatNumber(save.gold) + '</span></div>' +
                '<div class="resource-item"><span class="resource-icon">üçñ</span><span class="resource-value">' + formatNumber(save.food) + '</span></div>' +
                '<div class="resource-item"><span class="resource-icon">ü™µ</span><span class="resource-value">' + formatNumber(save.wood) + '</span></div>' +
                '<div class="resource-item"><span class="resource-icon">ü™®</span><span class="resource-value">' + formatNumber(save.stone) + '</span></div>' +
                '</div></div>' +
                '<div class="card-footer" style="margin-top:0;">' +
                '<button class="btn btn-primary btn-sm" onclick="loadGame(' + i + ')">Load</button>' +
                '<button class="btn btn-danger btn-sm" onclick="deleteGame(' + i + ')">Delete</button>' +
                '</div></div>';
        } else {
            html += '<div class="save-slot empty" onclick="createNewGame(' + i + ')">' +
                '<div class="empty-icon">+</div>' +
                '<div class="empty-label">Empty Slot</div>' +
                '<div class="slot-number">Slot ' + i + '</div>' +
                '</div>';
        }
    }
    grid.innerHTML = html;
}

function createNewGame(slotNumber) {
    selectedSlot = slotNumber;
    selectedKingdom = -1;
    document.getElementById('town-name-input').value = '';
    document.getElementById('lord-name-input').value = '';
    document.getElementById('seed-input').value = '';
    createResources = {gold: 200, population: 10, food: 100, wood: 100, stone: 50, ore: 0};
    Object.keys(createResources).forEach(r => {
        const el = document.getElementById('create-' + r);
        if (el) el.textContent = createResources[r];
    });
    document.querySelectorAll('.kingdom-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('kingdom-details').style.display = 'none';
    document.getElementById('deity-info').style.display = 'none';
    document.getElementById('city-dot').style.display = 'none';
    updateMapOverlays(-1);
    updateCreateButton();
    updateSeed();
    switchCreationTab('town');
    showScreen('create-screen');
}

async function loadGame(slotNumber) {
    try {
        const data = await api('/api/saves/' + slotNumber + '/load', 'POST');
        activeSave = data;
        renderTown(data);
        showScreen('town-screen');
        showTab('town');
        startGameLoop();
    } catch(e) {
        console.error('Failed to load game:', e);
    }
}

function deleteGame(slotNumber) {
    showModal('Delete Save', 'Are you sure you want to delete save slot ' + slotNumber + '? This cannot be undone.', async function() {
        try {
            await api('/api/saves/' + slotNumber, 'DELETE');
            hideModal();
            loadSaves();
        } catch(e) {
            console.error('Failed to delete:', e);
            hideModal();
        }
    });
}

async function continueGame() {
    try {
        const data = await api('/api/saves');
        const saves = data.saves || data;
        if (saves && saves.length > 0) {
            const latest = saves.reduce((a, b) => (b.slot > a.slot ? b : a), saves[0]);
            await loadGame(latest.slot);
        } else {
            showScreen('save-select-screen');
            loadSaves();
        }
    } catch(e) {
        showScreen('save-select-screen');
        loadSaves();
    }
}

function switchCreationTab(tabName) {
    document.querySelectorAll('.creation-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    document.querySelectorAll('.creation-content').forEach(c => c.style.display = 'none');
    document.getElementById('creation-' + tabName).style.display = 'block';
}

function selectKingdom(kingdomId) {
    selectedKingdom = kingdomId;
    const kData = KINGDOM_DATA[kingdomId];
    const dId = KINGDOM_TO_DEITY[kingdomId];
    const deity = DEITY_DATA[dId];

    document.querySelectorAll('.kingdom-btn').forEach(b => b.classList.remove('selected'));
    const kingdoms = ['', 'vylfod', 'rabaric', 'elruhn', 'kelsin', 'gosain', 'yozuan'];
    const btn = document.querySelector('.kingdom-btn[data-kingdom="' + kingdoms[kingdomId] + '"]');
    if (btn) btn.classList.add('selected');

    document.getElementById('kingdom-details').style.display = 'block';
    document.getElementById('kingdom-detail-name').textContent = kData.name;
    document.getElementById('kingdom-detail-biomes').textContent = kData.biomes.join(', ');
    document.getElementById('kingdom-detail-climate').textContent = kData.climate;
    document.getElementById('kingdom-detail-favored').textContent = kData.favored.join(', ');
    document.getElementById('kingdom-detail-building').textContent = kData.building;

    document.getElementById('deity-info').style.display = 'block';
    document.getElementById('deity-name').textContent = deity.name;
    document.getElementById('deity-domain').textContent = deity.desc;
    document.getElementById('deity-passive').textContent = deity.passive;
    document.getElementById('deity-active').textContent = deity.active;
    document.getElementById('deity-bane').textContent = deity.bane;

    document.getElementById('map-kingdom-label').textContent = kData.name;

    updateMapOverlays(kingdomId);

    const dot = document.getElementById('city-dot');
    dot.style.display = 'block';

    if (boundaryCache[kingdomId] && boundaryCache[kingdomId].positions && boundaryCache[kingdomId].positions.length > 0) {
        const positions = boundaryCache[kingdomId].positions;
        const idx = Math.floor(Math.random() * positions.length);
        dot.style.left = (positions[idx][0] * 100) + '%';
        dot.style.top = (positions[idx][1] * 100) + '%';
    } else {
        const center = KINGDOM_CENTERS[kingdomId];
        dot.style.left = (center.x * 100) + '%';
        dot.style.top = (center.y * 100) + '%';
    }

    fetchBoundaryData(kingdomId).then(function() {
        if (boundaryCache[kingdomId] && boundaryCache[kingdomId].positions && boundaryCache[kingdomId].positions.length > 0) {
            const positions = boundaryCache[kingdomId].positions;
            const idx = Math.floor(Math.random() * positions.length);
            dot.style.left = (positions[idx][0] * 100) + '%';
            dot.style.top = (positions[idx][1] * 100) + '%';
        }
    });
    updateSeed();
    updateCreateButton();
}

function updateMapOverlays(kingdomId) {
    for (let i = 1; i <= 6; i++) {
        const hl = document.getElementById('highlight-' + i);
        const sh = document.getElementById('shadow-' + i);
        if (kingdomId === -1) {
            if (hl) hl.style.display = 'none';
            if (sh) sh.style.display = 'none';
        } else if (i === kingdomId) {
            if (hl) hl.style.display = 'block';
            if (sh) sh.style.display = 'none';
        } else {
            if (hl) hl.style.display = 'none';
            if (sh) sh.style.display = 'block';
        }
    }
}

async function fetchBoundaryData(kingdomId) {
    if (boundaryCache[kingdomId]) return boundaryCache[kingdomId];
    try {
        const data = await api('/api/map/boundary/' + kingdomId);
        boundaryCache[kingdomId] = data;
        return data;
    } catch(e) {
        return null;
    }
}

function isPositionInKingdom(relX, relY, kingdomId) {
    const bd = boundaryCache[kingdomId];
    if (!bd || !bd.positions) return true;
    const positions = bd.positions;
    let minDist = Infinity;
    for (let i = 0; i < positions.length; i++) {
        const dx = relX - positions[i][0];
        const dy = relY - positions[i][1];
        const d = dx * dx + dy * dy;
        if (d < minDist) minDist = d;
    }
    return minDist < 0.002;
}

function findNearestValidPosition(relX, relY, kingdomId) {
    const bd = boundaryCache[kingdomId];
    if (!bd || !bd.positions || bd.positions.length === 0) return {x: relX, y: relY};
    const positions = bd.positions;
    let minDist = Infinity;
    let nearest = {x: relX, y: relY};
    for (let i = 0; i < positions.length; i++) {
        const dx = relX - positions[i][0];
        const dy = relY - positions[i][1];
        const d = dx * dx + dy * dy;
        if (d < minDist) {
            minDist = d;
            nearest = {x: positions[i][0], y: positions[i][1]};
        }
    }
    return nearest;
}

async function randomizeDot() {
    if (selectedKingdom === -1) return;
    const bd = await fetchBoundaryData(selectedKingdom);
    const dot = document.getElementById('city-dot');
    if (bd && bd.positions && bd.positions.length > 0) {
        const idx = Math.floor(Math.random() * bd.positions.length);
        const pos = bd.positions[idx];
        dot.style.left = (pos[0] * 100) + '%';
        dot.style.top = (pos[1] * 100) + '%';
    } else {
        const center = KINGDOM_CENTERS[selectedKingdom];
        const offsetX = (Math.random() - 0.5) * 0.05;
        const offsetY = (Math.random() - 0.5) * 0.05;
        dot.style.left = ((center.x + offsetX) * 100) + '%';
        dot.style.top = ((center.y + offsetY) * 100) + '%';
    }
}

function onMapClick(event) {
    if (selectedKingdom === -1) return;
    if (isDraggingDot) return;
    const container = document.getElementById('kingdom-map');
    const rect = container.getBoundingClientRect();
    const relX = (event.clientX - rect.left) / rect.width;
    const relY = (event.clientY - rect.top) / rect.height;

    const clampedX = Math.max(0, Math.min(1, relX));
    const clampedY = Math.max(0, Math.min(1, relY));

    if (boundaryCache[selectedKingdom] && boundaryCache[selectedKingdom].positions) {
        if (isPositionInKingdom(clampedX, clampedY, selectedKingdom)) {
            const dot = document.getElementById('city-dot');
            dot.style.left = (clampedX * 100) + '%';
            dot.style.top = (clampedY * 100) + '%';
        } else {
            const nearest = findNearestValidPosition(clampedX, clampedY, selectedKingdom);
            const dot = document.getElementById('city-dot');
            dot.style.left = (nearest.x * 100) + '%';
            dot.style.top = (nearest.y * 100) + '%';
        }
    } else {
        const dot = document.getElementById('city-dot');
        dot.style.left = (clampedX * 100) + '%';
        dot.style.top = (clampedY * 100) + '%';
    }
}

function setupMapDrag() {
    const dot = document.getElementById('city-dot');
    const container = document.getElementById('kingdom-map');

    function startDrag(e) {
        if (selectedKingdom === -1) return;
        e.preventDefault();
        e.stopPropagation();
        isDraggingDot = true;
    }

    function moveDrag(e) {
        if (!isDraggingDot) return;
        e.preventDefault();
        const rect = container.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        let relX = (clientX - rect.left) / rect.width;
        let relY = (clientY - rect.top) / rect.height;
        relX = Math.max(0, Math.min(1, relX));
        relY = Math.max(0, Math.min(1, relY));

        if (boundaryCache[selectedKingdom] && boundaryCache[selectedKingdom].positions) {
            if (!isPositionInKingdom(relX, relY, selectedKingdom)) {
                const nearest = findNearestValidPosition(relX, relY, selectedKingdom);
                relX = nearest.x;
                relY = nearest.y;
            }
        }

        dot.style.left = (relX * 100) + '%';
        dot.style.top = (relY * 100) + '%';
    }

    function endDrag(e) {
        if (isDraggingDot) {
            isDraggingDot = false;
            setTimeout(function() { isDraggingDot = false; }, 50);
        }
    }

    dot.addEventListener('mousedown', startDrag);
    dot.addEventListener('touchstart', startDrag, {passive: false});
    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag, {passive: false});
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    container.addEventListener('click', function(e) {
        if (e.target === dot) return;
        onMapClick(e);
    });
}

function adjustResource(resource, delta) {
    createResources[resource] = Math.max(0, (createResources[resource] || 0) + delta);
    const el = document.getElementById('create-' + resource);
    if (el) el.textContent = createResources[resource];
    updateSeed();
}

function computeSeedHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const ch = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + ch;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36).toUpperCase().padStart(8, '0').substring(0, 8);
}

function updateSeed() {
    const townName = document.getElementById('town-name-input').value;
    const lordName = document.getElementById('lord-name-input').value;
    const parts = [
        townName,
        lordName,
        selectedKingdom.toString(),
        createResources.gold.toString(),
        createResources.population.toString(),
        createResources.food.toString(),
        createResources.wood.toString(),
        createResources.stone.toString(),
        createResources.ore.toString()
    ];
    const combined = parts.join('|');
    document.getElementById('seed-input').value = computeSeedHash(combined);
}

function updateCreateButton() {
    const townName = document.getElementById('town-name-input').value.trim();
    const lordName = document.getElementById('lord-name-input').value.trim();
    const btn = document.getElementById('create-btn');
    btn.disabled = !(selectedKingdom > 0 && townName.length > 0 && lordName.length > 0);
}

var LORD_OPTIONS = {
    title: {choices: ['Lord','Lady','Baron','Baroness','Duke','Duchess','Count','Countess','Regent','Sovereign','Warden','Keeper','Commander','Archon','Chancellor'], index: 0},
    skin: {choices: ['Fair','Light','Medium','Tan','Olive','Brown','Dark','Ebony'], index: 0,
           colors: ['#FDDCB5','#F5CBA7','#E0B08A','#C9976B','#A67C52','#8B5E3C','#6B4226','#3D2314']},
    hair: {choices: ['Short','Long','Braided','Shaved','Ponytail','Curly','Mohawk','Bald'], index: 0},
    haircolor: {choices: ['Brown','Black','Blonde','Red','Silver','White','Auburn','Blue-Black'], index: 0,
                colors: ['#8B4513','#1a1a1a','#DAA520','#B22222','#C0C0C0','#F5F5F5','#A0522D','#191970']},
    eyes: {choices: ['Blue','Green','Brown','Hazel','Grey','Amber','Violet','Black'], index: 0,
           colors: ['#4A90D9','#2E8B57','#8B4513','#C9A95C','#808080','#FFBF00','#9B30FF','#1a1a1a']},
    outfit: {choices: ['Noble Robes','Battle Armor','Scholar Garb','Ranger Cloak','Royal Plate','Mystic Vestments','Merchant Attire','Assassin Leathers'], index: 0,
             colors: ['#8B0000','#4A4A4A','#2E4057','#2D5016','#DAA520','#4B0082','#8B6914','#2F2F2F']},
    accessory: {choices: ['None','Crown','Circlet','Eyepatch','Scar','Monocle','War Paint','Hood'], index: 0}
};

function cycleLordOption(key, delta) {
    var opt = LORD_OPTIONS[key];
    opt.index = ((opt.index + delta) % opt.choices.length + opt.choices.length) % opt.choices.length;
    document.getElementById('lord-' + key + '-val').textContent = opt.choices[opt.index];
    updateLordPreview();
    updateSeed();
}

function randomizeLordAppearance() {
    Object.keys(LORD_OPTIONS).forEach(function(key) {
        var opt = LORD_OPTIONS[key];
        opt.index = Math.floor(Math.random() * opt.choices.length);
        var el = document.getElementById('lord-' + key + '-val');
        if (el) el.textContent = opt.choices[opt.index];
    });
    updateLordPreview();
    updateSeed();
}

function updateLordPreview() {
    var preview = document.getElementById('lord-preview');
    if (!preview) return;
    var skin = LORD_OPTIONS.skin;
    var skinColor = skin.colors ? skin.colors[skin.index] : '#FDDCB5';
    var hair = LORD_OPTIONS.hair;
    var hc = LORD_OPTIONS.haircolor;
    var hairColor = hc.colors ? hc.colors[hc.index] : '#8B4513';
    var eyes = LORD_OPTIONS.eyes;
    var eyeColor = eyes.colors ? eyes.colors[eyes.index] : '#4A90D9';
    var outfit = LORD_OPTIONS.outfit;
    var outfitColor = outfit.colors ? outfit.colors[outfit.index] : '#8B0000';
    var acc = LORD_OPTIONS.accessory;

    var bodyEl = document.getElementById('lp-body');
    var headEl = document.getElementById('lp-head');
    var hairEl = document.getElementById('lp-hair');
    var outfitEl = document.getElementById('lp-outfit');
    var accEl = document.getElementById('lp-acc');

    bodyEl.style.background = skinColor;
    headEl.style.background = skinColor;
    headEl.innerHTML = '<div class="lp-eye" style="background:' + eyeColor + ';left:30%;"></div><div class="lp-eye" style="background:' + eyeColor + ';right:30%;"></div>';

    var hairStyle = hair.choices[hair.index];
    hairEl.style.background = hairColor;
    hairEl.style.display = hairStyle === 'Bald' ? 'none' : 'block';
    hairEl.className = 'lord-preview-hair lp-hair-' + hairStyle.toLowerCase().replace(/\s+/g,'-');

    outfitEl.style.background = outfitColor;
    outfitEl.className = 'lord-preview-outfit';

    var accName = acc.choices[acc.index];
    accEl.style.display = accName === 'None' ? 'none' : 'block';
    accEl.textContent = accName === 'Crown' ? 'üëë' : accName === 'Circlet' ? 'üíé' : accName === 'Eyepatch' ? 'üè¥' : accName === 'Scar' ? '‚öîÔ∏è' : accName === 'Monocle' ? 'üßê' : accName === 'War Paint' ? 'üé≠' : accName === 'Hood' ? 'üß•' : '';
}

function getLordAppearance() {
    var result = {};
    Object.keys(LORD_OPTIONS).forEach(function(key) {
        result[key] = LORD_OPTIONS[key].choices[LORD_OPTIONS[key].index];
        result[key + '_index'] = LORD_OPTIONS[key].index;
    });
    return result;
}

async function submitCreate() {
    const townName = document.getElementById('town-name-input').value.trim();
    const lordName = document.getElementById('lord-name-input').value.trim();
    const seed = document.getElementById('seed-input').value.trim();

    const dot = document.getElementById('city-dot');
    const dotX = parseFloat(dot.style.left) / 100;
    const dotY = parseFloat(dot.style.top) / 100;

    const lordTitle = LORD_OPTIONS.title.choices[LORD_OPTIONS.title.index];
    const fullLordName = lordTitle + ' ' + lordName;
    const body = {
        slot: selectedSlot,
        town_name: townName,
        lord_name: fullLordName,
        kingdom_id: selectedKingdom,
        seed: seed,
        position_x: dotX,
        position_y: dotY,
        starting_resources: createResources,
        lord_appearance: getLordAppearance()
    };

    try {
        const data = await api('/api/saves', 'POST', body);
        activeSave = data;
        renderTown(data);
        showScreen('town-screen');
        showTab('town');
        startGameLoop();
    } catch(e) {
        console.error('Failed to create game:', e);
    }
}

function renderTown(saveData) {
    activeSave = saveData;
    var gd = saveData.game_data || {};
    updateResourceBar(saveData);

    document.getElementById('town-header-name').textContent = saveData.town_name || 'Unknown Town';
    document.getElementById('town-header-lord').textContent = 'Lord ' + (saveData.lord_name || 'Unknown');
    var kName = KINGDOM_DATA[saveData.kingdom_id] ? KINGDOM_DATA[saveData.kingdom_id].name : '';
    document.getElementById('town-header-kingdom').textContent = kName;

    var lordContainer = document.getElementById('lord-sprite-container');
    var lordApp = (gd.lord_appearance);
    if (lordApp && lordApp.part_folders) {
        lordContainer.innerHTML = createSpriteCanvas(lordApp, 96, 'lord-sprite');
    } else {
        lordContainer.innerHTML = '<div class="lord-sprite-placeholder">üëë</div>';
    }

    renderBuildings(saveData.buildings || gd.buildings || {});
    var expData = gd.expeditions || {};
    renderExpeditions(expData.active || saveData.active_expedition, gd.expedition_board || saveData.expedition_board);
    renderAdventurers(gd.adventurers || saveData.adventurers || []);
    renderThreats(gd.dungeons || saveData.dungeons || []);
}

function updateResourceBar(save) {
    if (!save) return;
    const resources = save.resources || save;
    const fields = ['gold', 'food', 'wood', 'stone', 'ore', 'gems', 'relics', 'knowledge', 'mana', 'population'];
    fields.forEach(f => {
        const el = document.getElementById('res-' + f);
        if (el) el.textContent = formatNumber(resources[f] || save[f] || 0);
    });
    document.getElementById('day-counter').textContent = 'Day ' + (save.day || 1);
}

function renderBuildings(buildings) {
    const grid = document.getElementById('buildings-grid');
    let html = '';
    Object.keys(BUILDING_TYPES).forEach(key => {
        const bt = BUILDING_TYPES[key];
        const level = (buildings[key] && buildings[key].level) || 0;
        const icon = BUILDING_ICONS[key] || 'üèóÔ∏è';
        const prodText = Object.keys(bt.production).map(r => '+' + bt.production[r] + ' ' + r).join(', ') || 'Special';
        const costText = Object.keys(bt.cost).map(r => bt.cost[r] * (level + 1) + ' ' + r).join(', ');

        html += '<div class="building-card">' +
            '<div class="building-icon" style="width:64px;height:64px;font-size:32px;">' + icon +
            (level > 0 ? '<span class="building-level">' + level + '</span>' : '') +
            '</div>' +
            '<div class="building-info">' +
            '<div class="building-name">' + bt.name + '</div>' +
            '<div class="building-production">' + prodText + '/day</div>' +
            '</div>' +
            '<button class="upgrade-btn" onclick="upgradeBuild(\'' + key + '\')"' + (level >= bt.max_level ? ' disabled' : '') + '>' +
            (level === 0 ? 'Build' : (level >= bt.max_level ? 'Max' : 'Upgrade')) +
            '<br><span style="font-size:10px;font-weight:400;">' + costText + '</span></button>' +
            '</div>';
    });
    grid.innerHTML = html;
}

async function upgradeBuild(buildingId) {
    try {
        const data = await api('/api/game/build', 'POST', {building_id: buildingId});
        if (data) renderTown(data);
    } catch(e) {
        console.error('Build failed:', e);
    }
}

function renderExpeditions(activeExp, board) {
    const activeEl = document.getElementById('active-expedition');
    if (activeExp) {
        const progress = activeExp.progress || 0;
        activeEl.innerHTML = '<div class="card">' +
            '<div class="card-header"><h3 class="card-title">Active Expedition</h3><span class="badge">' + (activeExp.party_size || 0) + ' party</span></div>' +
            '<div class="card-body">' +
            '<div class="progress-bar"><div class="progress-fill" style="width:' + progress + '%;"></div></div>' +
            '<p class="mt-8 text-secondary">Returns on Day ' + (activeExp.return_day || '?') + '</p>' +
            '</div></div>';
    } else {
        activeEl.innerHTML = '';
    }

    const boardEl = document.getElementById('job-board');
    const refreshEl = document.getElementById('board-refresh');
    if (board && board.refresh_in !== undefined) {
        refreshEl.textContent = 'Refreshes in ' + board.refresh_in + ' days';
    }

    const jobs = (board && board.jobs) || [];
    if (jobs.length === 0) {
        boardEl.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öîÔ∏è</div><div class="empty-text">No expeditions available</div></div>';
        return;
    }

    let html = '';
    jobs.forEach(function(job, idx) {
        const riskClass = job.risk <= 3 ? 'risk-low' : (job.risk <= 6 ? 'risk-medium' : 'risk-high');
        const riskLabel = job.risk <= 3 ? 'Low' : (job.risk <= 6 ? 'Medium' : 'High');
        html += '<div class="job-card">' +
            '<div class="job-icon">' + (job.icon || 'üó°Ô∏è') + '</div>' +
            '<div class="job-info">' +
            '<div class="job-name">' + (job.type || 'Expedition') + ' ‚Äî ' + (job.target || 'Unknown') + '</div>' +
            '<div class="job-duration">' + (job.duration || '?') + ' days</div>' +
            '<div class="job-reward">' + (job.reward_hint || 'Various loot') + '</div>' +
            '</div>' +
            '<span class="risk-indicator ' + riskClass + '">' + riskLabel + '</span>' +
            '<button class="btn btn-primary btn-sm" onclick="startExpedition(' + idx + ')">Deploy</button>' +
            '</div>';
    });
    boardEl.innerHTML = html;
}

async function startExpedition(jobIndex) {
    try {
        const data = await api('/api/game/expedition/start', 'POST', {job_index: jobIndex});
        if (data) renderTown(data);
    } catch(e) {
        console.error('Expedition start failed:', e);
    }
}

function renderAdventurers(adventurers) {
    const roster = document.getElementById('adventurer-roster');
    const summary = document.getElementById('roster-summary');
    if (!adventurers || adventurers.length === 0) {
        roster.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">No adventurers recruited yet</div></div>';
        if (summary) summary.innerHTML = '';
        return;
    }

    var idle = 0, deployed = 0, injured = 0, dead = 0;
    adventurers.forEach(function(a) {
        if (a.status === 'deployed') deployed++;
        else if (a.status === 'injured' || a.status === 'recovering') injured++;
        else if (a.status === 'dead') dead++;
        else idle++;
    });
    if (summary) {
        summary.innerHTML = '<span class="roster-count">' + adventurers.length + ' adventurers</span>' +
            '<span class="roster-stat rs-idle">' + idle + ' idle</span>' +
            '<span class="roster-stat rs-deployed">' + deployed + ' deployed</span>' +
            (injured > 0 ? '<span class="roster-stat rs-injured">' + injured + ' injured</span>' : '') +
            (dead > 0 ? '<span class="roster-stat rs-dead">' + dead + ' dead</span>' : '');
    }

    var statusInfo = {
        idle: {label:'Idle', color:'#4ade80', icon:'üü¢'},
        deployed: {label:'Deployed', color:'#facc15', icon:'üü°'},
        injured: {label:'Injured', color:'#f97316', icon:'üü†'},
        recovering: {label:'Recovering', color:'#60a5fa', icon:'üîµ'},
        dead: {label:'Dead', color:'#ef4444', icon:'üî¥'}
    };

    var statCategories = {
        military: {label: 'Military', icon: '‚öîÔ∏è', stats: ['strength', 'endurance', 'tactics']},
        mystic: {label: 'Mystic', icon: '‚ú®', stats: ['magic', 'wisdom', 'faith']},
        survival: {label: 'Survival', icon: 'üèïÔ∏è', stats: ['survival', 'exploration']},
        civic: {label: 'Civic', icon: 'üèõÔ∏è', stats: ['diplomacy', 'leadership', 'justice']},
        commerce: {label: 'Commerce', icon: 'üí∞', stats: ['wealth', 'trade']},
        mobility: {label: 'Mobility', icon: 'üí®', stats: ['speed']}
    };

    var statDisplayNames = {
        strength:'STR', endurance:'END', tactics:'TAC',
        magic:'MAG', wisdom:'WIS', faith:'FAI',
        survival:'SRV', exploration:'EXP',
        diplomacy:'DIP', leadership:'LDR', justice:'JUS',
        wealth:'WLT', trade:'TRD', speed:'SPD'
    };

    var html = '';
    adventurers.forEach(function(adv, idx) {
        var si = statusInfo[adv.status] || statusInfo.idle;
        var hpPct = adv.max_hp ? Math.round((adv.hp / adv.max_hp) * 100) : 100;
        var hpColor = hpPct > 60 ? '#4ade80' : (hpPct > 30 ? '#facc15' : '#ef4444');
        var morale = adv.morale || 100;
        var moralePct = Math.min(100, morale);
        var moraleColor = morale > 70 ? '#4ade80' : (morale > 40 ? '#facc15' : '#ef4444');
        var xpPct = adv.xp_to_next ? Math.round((adv.xp / adv.xp_to_next) * 100) : 0;
        var isDead = adv.status === 'dead';

        html += '<div class="adv-panel' + (isDead ? ' adv-dead' : '') + '" onclick="toggleAdvPanel(this)">';

        html += '<div class="adv-panel-header">';
        if (adv.appearance) {
            html += '<div class="adv-appearance-wrap">' + renderCharFigure(adv.appearance) + '</div>';
        } else {
            html += '<div class="adv-portrait-wrap"><span class="adv-portrait">' + (adv.portrait || 'üßô') + '</span></div>';
        }
        html += '<div class="adv-header-info">';
        html += '<div class="adv-name-row"><span class="adv-name">' + (adv.name || 'Unknown') + '</span>';
        html += '<span class="adv-status-badge" style="background:' + si.color + '20;color:' + si.color + ';border:1px solid ' + si.color + '40">' + si.icon + ' ' + si.label + '</span></div>';
        html += '<div class="adv-class-row"><span class="adv-class">' + (adv.class_name || 'Adventurer') + '</span>';
        html += '<span class="adv-level">Lv.' + (adv.level || 1) + '</span></div>';

        html += '<div class="adv-vital-bars">';
        html += '<div class="adv-vital"><span class="vital-label">HP</span><div class="vital-bar"><div class="vital-fill" style="width:' + hpPct + '%;background:' + hpColor + '"></div></div><span class="vital-val">' + (adv.hp||0) + '/' + (adv.max_hp||0) + '</span></div>';
        html += '<div class="adv-vital"><span class="vital-label">XP</span><div class="vital-bar"><div class="vital-fill" style="width:' + xpPct + '%;background:#a78bfa"></div></div><span class="vital-val">' + (adv.xp||0) + '/' + (adv.xp_to_next||100) + '</span></div>';
        html += '<div class="adv-vital"><span class="vital-label">Morale</span><div class="vital-bar"><div class="vital-fill" style="width:' + moralePct + '%;background:' + moraleColor + '"></div></div><span class="vital-val">' + morale + '</span></div>';
        html += '</div>';
        html += '</div>';
        html += '<div class="adv-expand-arrow">‚ñº</div>';
        html += '</div>';

        html += '<div class="adv-panel-body">';

        html += '<div class="adv-desc">' + (adv.desc || '') + '</div>';

        html += '<div class="adv-stats-grid">';
        for (var catKey in statCategories) {
            var cat = statCategories[catKey];
            html += '<div class="stat-category">';
            html += '<div class="stat-cat-header"><span class="stat-cat-icon">' + cat.icon + '</span><span class="stat-cat-label">' + cat.label + '</span></div>';
            cat.stats.forEach(function(skey) {
                var val = (adv.stats && adv.stats[skey]) ? adv.stats[skey] : 0;
                var maxStat = 20;
                var pct = Math.min(100, Math.round((val / maxStat) * 100));
                var barColor = val >= 12 ? '#4ade80' : (val >= 8 ? '#60a5fa' : (val >= 5 ? '#facc15' : '#ef4444'));
                html += '<div class="stat-entry"><span class="stat-abbr">' + (statDisplayNames[skey]||skey) + '</span>';
                html += '<div class="stat-bar-wrap"><div class="stat-bar-fill" style="width:' + pct + '%;background:' + barColor + '"></div></div>';
                html += '<span class="stat-num">' + val + '</span></div>';
            });
            html += '</div>';
        }
        html += '</div>';

        if (adv.traits && adv.traits.length > 0) {
            html += '<div class="adv-traits-section"><div class="adv-section-label">Traits</div><div class="adv-traits">';
            adv.traits.forEach(function(t) {
                html += '<div class="adv-trait"><span class="trait-name">' + t.name + '</span><span class="trait-desc">' + t.desc + '</span></div>';
            });
            html += '</div></div>';
        }

        if (adv.equipment) {
            html += '<div class="adv-equip-section"><div class="adv-section-label">Equipment</div><div class="adv-equip-grid">';
            for (var slot in adv.equipment) {
                var item = adv.equipment[slot];
                var slotLabel = slot.replace(/_/g, ' ').replace(/\b\w/g, function(c){return c.toUpperCase();});
                if (item) {
                    html += '<div class="equip-slot filled"><span class="equip-slot-label">' + slotLabel + '</span><span class="equip-item-name">' + item.name + '</span><span class="equip-quality quality-' + (item.quality||'common').toLowerCase() + '">' + (item.quality||'Common') + '</span></div>';
                } else {
                    html += '<div class="equip-slot empty"><span class="equip-slot-label">' + slotLabel + '</span><span class="equip-empty">Empty</span></div>';
                }
            }
            html += '</div></div>';
        }

        if (adv.appearance && adv.appearance.part_folders) {
            var BASE = ['Body','Head','Chest','Hands','Belt','Legs','Shoes'];
            var accEntries = [];
            for (var pn in adv.appearance.part_folders) {
                if (BASE.indexOf(pn) === -1 && adv.appearance.part_folders[pn]) {
                    accEntries.push({key: pn, val: adv.appearance.part_folders[pn]});
                }
            }
            if (accEntries.length > 0) {
                html += '<div class="adv-equip-section"><div class="adv-section-label">Accessories</div><div class="enemy-acc-list">';
                accEntries.forEach(function(e) {
                    var icon = ACC_ICONS[e.key] || '‚Ä¢';
                    html += '<span class="enemy-acc-tag">' + icon + ' ' + e.val + '</span>';
                });
                html += '</div></div>';
            }
        }
        if (adv.is_evil) {
            html += '<div style="margin-top:6px;"><span class="enemy-theme-badge cultist">Evil Adventurer</span></div>';
        }

        html += '<div class="adv-record">';
        html += '<div class="record-stat"><span class="record-label">Missions</span><span class="record-val">' + (adv.missions_completed||0) + '</span></div>';
        html += '<div class="record-stat"><span class="record-label">Kills</span><span class="record-val">' + (adv.kills||0) + '</span></div>';
        html += '<div class="record-stat"><span class="record-label">Days Hired</span><span class="record-val">' + (adv.days_hired||0) + '</span></div>';
        if (adv.injury_days_left > 0) {
            html += '<div class="record-stat"><span class="record-label">Recovery</span><span class="record-val" style="color:#f97316">' + adv.injury_days_left + ' days</span></div>';
        }
        html += '</div>';

        html += '</div>';
        html += '</div>';
    });
    roster.innerHTML = html;
}

function toggleAdvPanel(el) {
    el.classList.toggle('expanded');
}

function renderThreats(dungeons) {
    const list = document.getElementById('threats-list');
    if (!dungeons || dungeons.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üíÄ</div><div class="empty-text">No threats detected</div></div>';
        return;
    }
    let html = '';
    dungeons.forEach(function(d) {
        const threatPct = Math.min(100, Math.round((d.threat || 0) * 100));
        const stateLabel = d.state || 'dormant';
        html += '<div class="threat-card">' +
            '<div class="threat-header">' +
            '<div><div class="threat-name">' + (d.name || 'Unknown Site') + '</div>' +
            '<span class="text-secondary" style="font-size:12px;">' + (d.theme || '') + ' ‚Äî ' + (d.distance || '?') + ' leagues</span></div>' +
            '<span class="threat-level">' + stateLabel + '</span>' +
            '</div>' +
            '<div class="threat-bar"><div class="threat-fill" style="width:' + threatPct + '%;"></div></div>' +
            (d.desc ? '<div class="threat-desc">' + d.desc + '</div>' : '') +
            '</div>';
    });
    list.innerHTML = html;
}

var ACC_ICONS = {
    Bag: 'üéí', Melee: '‚öîÔ∏è', Ranged: 'üèπ', Shield: 'üõ°Ô∏è',
    Magic: '‚ú®', Effect: 'üî•', Wings: 'ü¶á', Mount: 'üêé',
    bag: 'üéí', melee: '‚öîÔ∏è', ranged: 'üèπ', shield: 'üõ°Ô∏è',
    magic: '‚ú®', effect: 'üî•', wings: 'ü¶á', mount: 'üêé'
};

var LAYER_Z_ORDER = {
    Mount: -10, Body: 0, Legs: 10, Shoes: 12, Chest: 20,
    Belt: 24, Head: 30, Hands: 40, Bag: 45, Shield: 46,
    Melee: 47, Ranged: 48, Magic: 60, Wings: 65, Effect: 90
};

var FRAME_SIZE = 128;
var _spriteImageCache = {};

function loadSpriteImage(folder, action) {
    var url = '/sprites/' + folder + '/' + (action || 'Idle') + '.png';
    if (_spriteImageCache[url]) return Promise.resolve(_spriteImageCache[url]);
    return new Promise(function(resolve) {
        var img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() { _spriteImageCache[url] = img; resolve(img); };
        img.onerror = function() {
            if (action !== 'Idle') {
                loadSpriteImage(folder, 'Idle').then(resolve);
            } else { resolve(null); }
        };
        img.src = url;
    });
}

function renderSpriteCharacter(canvas, appearance, opts) {
    if (!canvas || !appearance) return;
    opts = opts || {};
    var direction = opts.direction || 0;
    var frame = opts.frame || 0;
    var scale = opts.scale || 1;
    var size = opts.size || 128;

    canvas.width = size;
    canvas.height = size;
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, size, size);
    ctx.imageSmoothingEnabled = false;

    var partFolders = appearance.part_folders || {};
    var partColors = appearance.part_colors || {};

    var layers = [];
    for (var partName in partFolders) {
        var folder = partFolders[partName];
        if (!folder) continue;
        var z = LAYER_Z_ORDER[partName] !== undefined ? LAYER_Z_ORDER[partName] : 50;
        layers.push({part: partName, folder: folder, z: z, color: partColors[partName]});
    }
    layers.sort(function(a, b) { return a.z - b.z; });

    var promises = layers.map(function(layer) {
        return loadSpriteImage(layer.folder, 'Idle').then(function(img) {
            layer.img = img;
            return layer;
        });
    });

    Promise.all(promises).then(function(loadedLayers) {
        ctx.clearRect(0, 0, size, size);
        var drawScale = size / FRAME_SIZE;
        if (appearance.is_kid) drawScale *= (appearance.scale || 0.85);
        var offsetX = (size - FRAME_SIZE * drawScale) / 2;
        var offsetY = (size - FRAME_SIZE * drawScale);

        loadedLayers.forEach(function(layer) {
            if (!layer.img) return;
            var cols = Math.floor(layer.img.width / FRAME_SIZE);
            var col = frame % cols;
            var row = Math.min(direction, 7);
            var sx = col * FRAME_SIZE;
            var sy = row * FRAME_SIZE;

            if (layer.color && layer.color !== '#ffffff') {
                var offCanvas = document.createElement('canvas');
                offCanvas.width = FRAME_SIZE;
                offCanvas.height = FRAME_SIZE;
                var offCtx = offCanvas.getContext('2d');
                offCtx.imageSmoothingEnabled = false;
                offCtx.drawImage(layer.img, sx, sy, FRAME_SIZE, FRAME_SIZE, 0, 0, FRAME_SIZE, FRAME_SIZE);
                offCtx.globalCompositeOperation = 'multiply';
                offCtx.fillStyle = layer.color;
                offCtx.fillRect(0, 0, FRAME_SIZE, FRAME_SIZE);
                offCtx.globalCompositeOperation = 'destination-in';
                offCtx.drawImage(layer.img, sx, sy, FRAME_SIZE, FRAME_SIZE, 0, 0, FRAME_SIZE, FRAME_SIZE);
                ctx.drawImage(offCanvas, 0, 0, FRAME_SIZE, FRAME_SIZE,
                    offsetX, offsetY, FRAME_SIZE * drawScale, FRAME_SIZE * drawScale);
            } else {
                ctx.drawImage(layer.img, sx, sy, FRAME_SIZE, FRAME_SIZE,
                    offsetX, offsetY, FRAME_SIZE * drawScale, FRAME_SIZE * drawScale);
            }
        });
    });
}

function createSpriteCanvas(appearance, size, extraClass) {
    var s = size || 64;
    var cls = 'sprite-canvas' + (extraClass ? ' ' + extraClass : '');
    var id = 'sc_' + Math.random().toString(36).substr(2, 8);
    setTimeout(function() {
        var c = document.getElementById(id);
        if (c) renderSpriteCharacter(c, appearance, {size: s});
    }, 10);
    return '<canvas id="' + id + '" class="' + cls + '" width="' + s + '" height="' + s + '" style="width:' + s + 'px;height:' + s + 'px;image-rendering:pixelated;"></canvas>';
}

function renderCharFigure(appearance, extraClass) {
    if (!appearance || !appearance.part_folders) {
        return '<div class="char-figure-placeholder"></div>';
    }
    return createSpriteCanvas(appearance, 56, extraClass);
}

function renderPopulation(saveData) {
    var gd = saveData.game_data || {};
    var popData = gd.population || {};
    var civilians = popData.civilians || [];
    var families = popData.families || {};

    var statsBar = document.getElementById('pop-stats-bar');
    var familyCount = Object.keys(families).length;
    var kidCount = civilians.filter(function(c) { return c.is_kid; }).length;
    var adultCount = civilians.length - kidCount;
    var moodCounts = {};
    civilians.forEach(function(c) { var m = c.mood || 'neutral'; moodCounts[m] = (moodCounts[m] || 0) + 1; });

    statsBar.innerHTML =
        '<span class="pop-stat">Total: <span class="pop-stat-val">' + civilians.length + '</span></span>' +
        '<span class="pop-stat">Families: <span class="pop-stat-val">' + familyCount + '</span></span>' +
        '<span class="pop-stat">Adults: <span class="pop-stat-val">' + adultCount + '</span></span>' +
        '<span class="pop-stat">Children: <span class="pop-stat-val">' + kidCount + '</span></span>' +
        (moodCounts.happy ? '<span class="pop-stat">Happy: <span class="pop-stat-val" style="color:#4ade80">' + moodCounts.happy + '</span></span>' : '') +
        (moodCounts.worried ? '<span class="pop-stat">Worried: <span class="pop-stat-val" style="color:#facc15">' + moodCounts.worried + '</span></span>' : '');

    var familyHtml = '';
    for (var famId in families) {
        var fam = families[famId];
        var memberIds = fam.member_ids || [];
        var members = civilians.filter(function(c) { return c.family_id === famId; });

        familyHtml += '<div class="family-group">';
        familyHtml += '<div class="family-header"><span class="family-icon">üè†</span> The ' + fam.family_name + ' Family <span class="text-secondary" style="font-size:11px;">(' + members.length + ' members)</span></div>';
        familyHtml += '<div class="family-members">';
        members.forEach(function(npc) {
            familyHtml += renderNpcCard(npc);
        });
        familyHtml += '</div></div>';
    }
    document.getElementById('pop-families').innerHTML = familyHtml || '<div class="empty-state"><div class="empty-text">No families</div></div>';

    var singles = civilians.filter(function(c) { return !c.family_id; });
    var singlesHtml = '<div class="singles-grid">';
    singles.forEach(function(npc) {
        singlesHtml += renderNpcCard(npc);
    });
    singlesHtml += '</div>';
    document.getElementById('pop-singles').innerHTML = singles.length > 0 ? singlesHtml : '<div class="empty-state"><div class="empty-text">No singles</div></div>';

    var allHtml = '<div class="singles-grid">';
    civilians.forEach(function(npc) {
        allHtml += renderNpcCard(npc);
    });
    allHtml += '</div>';
    document.getElementById('pop-all').innerHTML = civilians.length > 0 ? allHtml : '<div class="empty-state"><div class="empty-text">No population</div></div>';
}

function renderNpcCard(npc) {
    var kidClass = npc.is_kid ? ' kid-card' : '';
    var moodClass = npc.mood || 'neutral';
    return '<div class="npc-card' + kidClass + '">' +
        renderCharFigure(npc.appearance) +
        '<div class="npc-info">' +
        '<div class="npc-name">' + (npc.name || 'Unknown') + '</div>' +
        '<div class="npc-role">' + (npc.role || 'Civilian') + '</div>' +
        '</div>' +
        '<span class="npc-mood ' + moodClass + '">' + moodClass + '</span>' +
        '</div>';
}

function showPopSubTab(tabName) {
    document.querySelectorAll('.pop-tab-content').forEach(function(el) { el.classList.remove('active'); });
    document.querySelectorAll('.pop-tab-btn').forEach(function(el) { el.classList.remove('active'); });
    var target = document.getElementById('pop-' + tabName);
    if (target) target.classList.add('active');
    event.target.classList.add('active');
}

function updateGameMap() {
    if (!activeSave) return;
    const kId = activeSave.kingdom_id;
    for (let i = 1; i <= 6; i++) {
        const hl = document.getElementById('game-highlight-' + i);
        const sh = document.getElementById('game-shadow-' + i);
        if (i === kId) {
            if (hl) hl.style.display = 'block';
            if (sh) sh.style.display = 'none';
        } else {
            if (hl) hl.style.display = 'none';
            if (sh) sh.style.display = 'block';
        }
    }
    const dot = document.getElementById('game-city-dot');
    if (activeSave.dot_x !== undefined) {
        dot.style.display = 'block';
        dot.style.left = (activeSave.dot_x * 100) + '%';
        dot.style.top = (activeSave.dot_y * 100) + '%';
    }
    const info = document.getElementById('game-kingdom-info');
    if (KINGDOM_DATA[kId]) {
        const k = KINGDOM_DATA[kId];
        info.innerHTML = '<h3 class="text-gold mb-8">' + k.name + '</h3>' +
            '<div class="card-body"><p><strong>Biomes:</strong> ' + k.biomes.join(', ') + '</p>' +
            '<p><strong>Climate:</strong> ' + k.climate + '</p>' +
            '<p><strong>Favored:</strong> ' + k.favored.join(', ') + '</p></div>';
    }
}

function startGameLoop() {
    stopGameLoop();
    gameTickInterval = setInterval(gameTick, 1000);
}

function stopGameLoop() {
    if (gameTickInterval) {
        clearInterval(gameTickInterval);
        gameTickInterval = null;
    }
}

async function gameTick() {
    if (currentScreen !== 'town-screen') return;
    try {
        const data = await api('/api/game/tick', 'POST');
        if (data) {
            activeSave = data;
            updateResourceBar(data);
        }
    } catch(e) {}
}

function showModal(title, message, onConfirm) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-overlay').classList.remove('hidden');
    const confirmBtn = document.getElementById('modal-confirm');
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
    newBtn.id = 'modal-confirm';
    newBtn.addEventListener('click', onConfirm);
}

function hideModal() {
    document.getElementById('modal-overlay').classList.add('hidden');
}

document.getElementById('town-name-input').addEventListener('input', updateCreateButton);
document.getElementById('lord-name-input').addEventListener('input', updateCreateButton);

setupMapDrag();
document.getElementById('seed-input').value = computeSeedHash('init' + Date.now());
updateLordPreview();

var CITY_GRID_SIZE = 12;
var CITY_CELL = 48;
var cityCanvas = null;
var cityCtx = null;
var cityInitialized = false;
var cityPlacedBuildings = [];
var citySelectedBuilding = null;
var cityRotation = 0;
var cityDemolishMode = false;
var cityHoverX = -1;
var cityHoverY = -1;
var citySpriteImages = {};
var cityGrassImg = null;
var citySpriteLoaded = false;

var CITY_SPRITE_MAP = {
    town_hall: {sprite: 'manor', gridW: 3, gridH: 2, icon: 'üèõÔ∏è'},
    tavern:    {sprite: 'cottage', gridW: 1, gridH: 1, icon: 'üç∫'},
    barracks:  {sprite: 'estate', gridW: 2, gridH: 2, icon: '‚öîÔ∏è'},
    market:    {sprite: 'guild', gridW: 2, gridH: 2, icon: 'üè™'},
    farm:      {sprite: 'house', gridW: 1, gridH: 1, icon: 'üåæ'},
    mine:      {sprite: 'bank', gridW: 2, gridH: 2, icon: '‚õèÔ∏è'},
    lumber_mill: {sprite: 'house', gridW: 1, gridH: 1, icon: 'ü™µ'},
    temple:    {sprite: 'temple', gridW: 2, gridH: 2, icon: '‚õ™'},
    library:   {sprite: 'school', gridW: 2, gridH: 2, icon: 'üìö'},
    smithy:    {sprite: 'cottage', gridW: 1, gridH: 1, icon: 'üî®'}
};

function getCitySpriteKey(buildingId, rotation) {
    var info = CITY_SPRITE_MAP[buildingId];
    if (!info) return null;
    var base = info.sprite;
    var w = info.gridW;
    var h = info.gridH;
    var r = rotation % 4;
    if (w === 1 && h === 1) {
        return (r === 1 || r === 3) ? base + '_1x1_flip' : base + '_1x1';
    }
    if (w === 2 && h === 2) {
        if (r === 0 || r === 2) return base + '_2x2';
        var flipped = base + '_1x1_flip';
        return citySpriteImages[flipped] ? flipped : base + '_2x2';
    }
    if (r === 0 || r === 2) return base + '_2x2';
    if (r === 1) {
        var k12 = base + '_1x2';
        return citySpriteImages[k12] ? k12 : base + '_2x2';
    }
    var k21 = base + '_2x1';
    return citySpriteImages[k21] ? k21 : base + '_2x2';
}

function getCityBuildingSize(buildingId, rotation) {
    var info = CITY_SPRITE_MAP[buildingId];
    if (!info) return {w: 1, h: 1};
    var w = info.gridW;
    var h = info.gridH;
    var r = rotation % 4;
    if (r === 1 || r === 3) return {w: h, h: w};
    return {w: w, h: h};
}

function loadCitySprites(callback) {
    if (citySpriteLoaded) { callback(); return; }
    var spriteNames = [
        'house_1x1', 'house_1x1_flip', 'house_1x2', 'house_2x1', 'house_2x2',
        'cottage_1x1', 'cottage_1x1_flip', 'cottage_1x2', 'cottage_2x1', 'cottage_2x2',
        'estate_1x1', 'estate_1x1_flip', 'estate_1x2', 'estate_2x1', 'estate_2x2',
        'bank_1x1', 'bank_1x1_flip', 'bank_2x2',
        'guild_1x1', 'guild_1x1_flip', 'guild_1x2', 'guild_2x1', 'guild_2x2',
        'school_1x1', 'school_1x1_flip', 'school_2x2',
        'temple_1x1', 'temple_1x1_flip', 'temple_2x2',
        'manor_1x1', 'manor_1x1_flip', 'manor_2x2'
    ];
    var loaded = 0;
    var total = spriteNames.length + 1;

    cityGrassImg = new Image();
    cityGrassImg.onload = function() { loaded++; if (loaded >= total) { citySpriteLoaded = true; callback(); } };
    cityGrassImg.onerror = function() { loaded++; if (loaded >= total) { citySpriteLoaded = true; callback(); } };
    cityGrassImg.src = '/static/images/buildings/grass_single.png';

    spriteNames.forEach(function(name) {
        var img = new Image();
        img.onload = function() { loaded++; if (loaded >= total) { citySpriteLoaded = true; callback(); } };
        img.onerror = function() { loaded++; if (loaded >= total) { citySpriteLoaded = true; callback(); } };
        img.src = '/static/images/buildings/' + name + '.png';
        citySpriteImages[name] = img;
    });
}

function initCityBuilder() {
    loadCitySprites(function() {
        cityCanvas = document.getElementById('city-canvas');
        cityCtx = cityCanvas.getContext('2d');

        var container = document.querySelector('.city-builder-container');
        var sidebarW = 148;
        var available = container.clientWidth - sidebarW;
        var canvasSize = Math.min(available, container.clientHeight, CITY_GRID_SIZE * CITY_CELL);
        CITY_CELL = Math.floor(canvasSize / CITY_GRID_SIZE);
        canvasSize = CITY_CELL * CITY_GRID_SIZE;

        cityCanvas.width = canvasSize;
        cityCanvas.height = canvasSize;
        cityCanvas.style.width = canvasSize + 'px';
        cityCanvas.style.height = canvasSize + 'px';

        if (!cityInitialized) {
            cityCanvas.addEventListener('mousemove', onCityMouseMove);
            cityCanvas.addEventListener('click', onCityClick);
            cityCanvas.addEventListener('mouseleave', function() {
                cityHoverX = -1; cityHoverY = -1; renderCity();
            });
            cityCanvas.addEventListener('touchstart', onCityTouch, {passive: false});
            cityCanvas.addEventListener('touchmove', onCityTouchMove, {passive: false});
            cityCanvas.addEventListener('touchend', onCityTouchEnd, {passive: false});
            cityInitialized = true;
        }

        var gd = activeSave ? (activeSave.game_data || {}) : {};
        cityPlacedBuildings = gd.city_grid || [];

        renderCityPalette();
        renderCity();
    });
}

function renderCityPalette() {
    var sidebar = document.getElementById('city-sidebar');
    var gd = activeSave ? (activeSave.game_data || {}) : {};
    var buildings = gd.buildings || {};
    var html = '';

    Object.keys(CITY_SPRITE_MAP).forEach(function(bid) {
        var bt = BUILDING_TYPES[bid];
        if (!bt) return;
        var info = CITY_SPRITE_MAP[bid];
        var level = (buildings[bid] && buildings[bid].level) || 0;
        var costMult = level + 1;
        var costText = Object.keys(bt.cost).map(function(r) { return (bt.cost[r] * costMult) + ' ' + r; }).join(', ');
        var thumbKey = info.sprite + '_1x1';
        var thumbSrc = '/static/images/buildings/' + thumbKey + '.png';

        var canAfford = true;
        if (level >= bt.max_level) canAfford = false;
        if (activeSave) {
            Object.keys(bt.cost).forEach(function(r) {
                var needed = bt.cost[r] * costMult;
                var have = activeSave[r] || 0;
                if (have < needed) canAfford = false;
            });
        }

        var sel = (citySelectedBuilding === bid) ? ' selected' : '';
        var dis = (!canAfford || level >= bt.max_level) ? ' disabled' : '';

        html += '<div class="city-palette-item' + sel + dis + '" onclick="selectCityBuilding(\'' + bid + '\')" data-bid="' + bid + '">';
        html += '<img class="city-palette-thumb" src="' + thumbSrc + '" alt="">';
        html += '<div class="city-palette-info">';
        html += '<div class="city-palette-name">' + bt.name + '</div>';
        if (level >= bt.max_level) {
            html += '<div class="city-palette-level">MAX Lv.' + level + '</div>';
        } else if (level > 0) {
            html += '<div class="city-palette-level">Lv.' + level + ' ‚Üí ' + (level+1) + '</div>';
            html += '<div class="city-palette-cost">' + costText + '</div>';
        } else {
            html += '<div class="city-palette-cost">' + costText + '</div>';
        }
        html += '</div></div>';
    });
    sidebar.innerHTML = html;
}

function selectCityBuilding(bid) {
    if (cityDemolishMode) toggleDemolish();
    if (citySelectedBuilding === bid) {
        citySelectedBuilding = null;
        document.getElementById('city-status').textContent = 'Select a building to place';
    } else {
        citySelectedBuilding = bid;
        cityRotation = 0;
        var bt = BUILDING_TYPES[bid];
        document.getElementById('city-status').textContent = 'Placing: ' + (bt ? bt.name : bid);
    }
    renderCityPalette();
    renderCity();
}

function rotatePlacement() {
    cityRotation = (cityRotation + 1) % 4;
    renderCity();
}

function toggleDemolish() {
    cityDemolishMode = !cityDemolishMode;
    var btn = document.getElementById('city-demolish-btn');
    if (cityDemolishMode) {
        btn.classList.add('active');
        citySelectedBuilding = null;
        document.getElementById('city-status').textContent = 'Demolish mode: click a building to remove';
    } else {
        btn.classList.remove('active');
        document.getElementById('city-status').textContent = 'Select a building to place';
    }
    renderCityPalette();
    renderCity();
}

function onCityMouseMove(e) {
    var rect = cityCanvas.getBoundingClientRect();
    var sx = (e.clientX - rect.left) * (cityCanvas.width / rect.width);
    var sy = (e.clientY - rect.top) * (cityCanvas.height / rect.height);
    cityHoverX = Math.floor(sx / CITY_CELL);
    cityHoverY = Math.floor(sy / CITY_CELL);
    renderCity();
}

function onCityClick(e) {
    var rect = cityCanvas.getBoundingClientRect();
    var sx = (e.clientX - rect.left) * (cityCanvas.width / rect.width);
    var sy = (e.clientY - rect.top) * (cityCanvas.height / rect.height);
    var gx = Math.floor(sx / CITY_CELL);
    var gy = Math.floor(sy / CITY_CELL);
    handleCityGridClick(gx, gy);
}

var cityLastTouchX = -1;
var cityLastTouchY = -1;

function onCityTouch(e) {
    e.preventDefault();
    var t = e.touches[0];
    var rect = cityCanvas.getBoundingClientRect();
    var sx = (t.clientX - rect.left) * (cityCanvas.width / rect.width);
    var sy = (t.clientY - rect.top) * (cityCanvas.height / rect.height);
    cityHoverX = Math.floor(sx / CITY_CELL);
    cityHoverY = Math.floor(sy / CITY_CELL);
    cityLastTouchX = cityHoverX;
    cityLastTouchY = cityHoverY;
    renderCity();
}

function onCityTouchMove(e) {
    e.preventDefault();
    var t = e.touches[0];
    var rect = cityCanvas.getBoundingClientRect();
    var sx = (t.clientX - rect.left) * (cityCanvas.width / rect.width);
    var sy = (t.clientY - rect.top) * (cityCanvas.height / rect.height);
    cityHoverX = Math.floor(sx / CITY_CELL);
    cityHoverY = Math.floor(sy / CITY_CELL);
    cityLastTouchX = cityHoverX;
    cityLastTouchY = cityHoverY;
    renderCity();
}

function onCityTouchEnd(e) {
    e.preventDefault();
    if (cityLastTouchX >= 0 && cityLastTouchY >= 0) {
        handleCityGridClick(cityLastTouchX, cityLastTouchY);
    }
    cityLastTouchX = -1;
    cityLastTouchY = -1;
}

function handleCityGridClick(gx, gy) {
    if (gx < 0 || gy < 0 || gx >= CITY_GRID_SIZE || gy >= CITY_GRID_SIZE) return;

    if (cityDemolishMode) {
        var idx = findPlacedBuildingAt(gx, gy);
        if (idx >= 0) {
            cityPlacedBuildings.splice(idx, 1);
            saveCityGrid();
            renderCity();
        }
        return;
    }

    if (!citySelectedBuilding) return;

    var size = getCityBuildingSize(citySelectedBuilding, cityRotation);
    if (gx + size.w > CITY_GRID_SIZE || gy + size.h > CITY_GRID_SIZE) return;
    if (!isCityPlacementValid(gx, gy, size.w, size.h)) return;

    placeCityBuilding(citySelectedBuilding, gx, gy, cityRotation);
}

function isCityPlacementValid(gx, gy, w, h) {
    for (var i = 0; i < cityPlacedBuildings.length; i++) {
        var p = cityPlacedBuildings[i];
        var ps = getCityBuildingSize(p.building_id, p.rotation);
        if (gx < p.grid_x + ps.w && gx + w > p.grid_x &&
            gy < p.grid_y + ps.h && gy + h > p.grid_y) {
            return false;
        }
    }
    return true;
}

function findPlacedBuildingAt(gx, gy) {
    for (var i = 0; i < cityPlacedBuildings.length; i++) {
        var p = cityPlacedBuildings[i];
        var ps = getCityBuildingSize(p.building_id, p.rotation);
        if (gx >= p.grid_x && gx < p.grid_x + ps.w &&
            gy >= p.grid_y && gy < p.grid_y + ps.h) {
            return i;
        }
    }
    return -1;
}

async function placeCityBuilding(bid, gx, gy, rot) {
    try {
        var data = await api('/api/game/build', 'POST', {
            slot_number: activeSave.slot_number,
            building_id: bid
        });
        if (data) {
            activeSave = data;
            var spriteKey = getCitySpriteKey(bid, rot);
            cityPlacedBuildings.push({
                building_id: bid,
                grid_x: gx,
                grid_y: gy,
                rotation: rot,
                sprite_key: spriteKey
            });
            saveCityGrid();
            updateResourceBar(data);
            renderCityPalette();
            renderCity();
            document.getElementById('city-status').textContent = (BUILDING_TYPES[bid] ? BUILDING_TYPES[bid].name : bid) + ' placed!';
            citySelectedBuilding = null;
            renderCityPalette();
        }
    } catch(e) {
        document.getElementById('city-status').textContent = 'Cannot afford this building';
        console.error('Build failed:', e);
    }
}

async function saveCityGrid() {
    if (!activeSave) return;
    try {
        await api('/api/saves/' + activeSave.slot_number + '/update_city', 'POST', {
            city_grid: cityPlacedBuildings
        });
        var gd = activeSave.game_data || {};
        gd.city_grid = cityPlacedBuildings;
        activeSave.game_data = gd;
    } catch(e) {
        console.error('Failed to save city grid:', e);
    }
}

function renderCity() {
    if (!cityCtx) return;
    var ctx = cityCtx;
    var cs = CITY_CELL;
    var total = CITY_GRID_SIZE * cs;
    ctx.imageSmoothingEnabled = false;

    ctx.fillStyle = '#2a3a2a';
    ctx.fillRect(0, 0, total, total);

    if (cityGrassImg && cityGrassImg.complete) {
        for (var gy = 0; gy < CITY_GRID_SIZE; gy++) {
            for (var gx = 0; gx < CITY_GRID_SIZE; gx++) {
                ctx.drawImage(cityGrassImg, gx * cs, gy * cs, cs, cs);
            }
        }
    }

    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;
    for (var i = 0; i <= CITY_GRID_SIZE; i++) {
        ctx.beginPath();
        ctx.moveTo(i * cs, 0);
        ctx.lineTo(i * cs, total);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * cs);
        ctx.lineTo(total, i * cs);
        ctx.stroke();
    }

    cityPlacedBuildings.forEach(function(p) {
        var sk = p.sprite_key || getCitySpriteKey(p.building_id, p.rotation);
        var img = citySpriteImages[sk];
        var size = getCityBuildingSize(p.building_id, p.rotation);
        var dx = p.grid_x * cs;
        var dy = p.grid_y * cs;
        var dw = size.w * cs;
        var dh = size.h * cs;
        if (img && img.complete && img.naturalWidth > 0) {
            ctx.drawImage(img, dx, dy, dw, dh);
        } else {
            var info = CITY_SPRITE_MAP[p.building_id];
            ctx.fillStyle = 'rgba(100,100,200,0.5)';
            ctx.fillRect(dx + 1, dy + 1, dw - 2, dh - 2);
            ctx.fillStyle = '#fff';
            ctx.font = Math.floor(cs * 0.5) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(info ? info.icon : '?', dx + dw/2, dy + dh/2);
        }
    });

    if (citySelectedBuilding && cityHoverX >= 0 && cityHoverY >= 0) {
        var size = getCityBuildingSize(citySelectedBuilding, cityRotation);
        var fits = (cityHoverX + size.w <= CITY_GRID_SIZE && cityHoverY + size.h <= CITY_GRID_SIZE);
        var valid = fits && isCityPlacementValid(cityHoverX, cityHoverY, size.w, size.h);

        ctx.fillStyle = valid ? 'rgba(74,222,128,0.3)' : 'rgba(239,68,68,0.3)';
        ctx.fillRect(cityHoverX * cs, cityHoverY * cs, size.w * cs, size.h * cs);
        ctx.strokeStyle = valid ? 'rgba(74,222,128,0.8)' : 'rgba(239,68,68,0.8)';
        ctx.lineWidth = 2;
        ctx.strokeRect(cityHoverX * cs, cityHoverY * cs, size.w * cs, size.h * cs);

        var sk = getCitySpriteKey(citySelectedBuilding, cityRotation);
        var img = citySpriteImages[sk];
        if (img && img.complete && img.naturalWidth > 0) {
            ctx.globalAlpha = 0.6;
            ctx.drawImage(img, cityHoverX * cs, cityHoverY * cs, size.w * cs, size.h * cs);
            ctx.globalAlpha = 1.0;
        }
    }

    if (cityDemolishMode && cityHoverX >= 0 && cityHoverY >= 0) {
        var idx = findPlacedBuildingAt(cityHoverX, cityHoverY);
        if (idx >= 0) {
            var p = cityPlacedBuildings[idx];
            var size = getCityBuildingSize(p.building_id, p.rotation);
            ctx.fillStyle = 'rgba(239,68,68,0.3)';
            ctx.fillRect(p.grid_x * cs, p.grid_y * cs, size.w * cs, size.h * cs);
            ctx.strokeStyle = 'rgba(239,68,68,0.8)';
            ctx.lineWidth = 2;
            ctx.strokeRect(p.grid_x * cs, p.grid_y * cs, size.w * cs, size.h * cs);
        }
    }
}
</script>

</body>
</html>